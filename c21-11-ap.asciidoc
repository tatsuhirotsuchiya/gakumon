= 学問への扉：計算機プログラミング入門

== タイルマップ

地形や背景を実現するのに便利。

タイルマップは、256x256の行列。
0から7まで、8個のタイルマップがある。

1つのタイルマップの65536個のそれぞれのエントリをタイルとよぶ。
タイルは、0から1023までの整数値。

タイルは、イメージマップの8x8の領域に対応づけられる。
タイルが値0ならイメージマップの(0, 0)から(7, 7)の領域に対応。
値が1なら(8, 0)から(15, 7)。
値が32なら、(0, 8)から(7, 15)、
値が33なら、(8, 8)から(15, 15)。というように、32増えると下に
8ピクセルすすむ。

=== プログラムからタイルマップへの書き込み

`pyxel.tilemap(0).set(x, y, ["000"])`

タイル(x, y)に0を設定。"000"の部分は16進数で0から1023までを指定。
"000"から"3ff"までとなる。

複数タイルに同時に設定できる。

`pyxel.tilemap(0).set(x, y, ["000001", "002003"])`

タイル(x, y)→0, (x+1, y)→1, (x, y+1)→2, (x+1, y+1)→3

pyxeleditor で設定することも可能。

=== プログラムからタイルの情報を取得

`pyxel.tilemap(0).get(x, y)`

(x, y) のタイルの情報をゲット。0～1024の整数値が得られる。

=== イメージマップの表示

`draw()` の中にかいておく。例

`pyxel.bltm(x, y, 0, 0, 0, 16, 16)`


意味：画面の(x,y)にタイルマップ0の(0,0)から16x16分のタイルを表示。
1タイル8x8だから画面上の128x128の領域に表示される。

=== サンプルプログラム

迷路っぽい何か。

[source,python]
----
import pyxel
pyxel.init(128, 128)

# グラフィックス
# イメージバンク0に8x16のイメージを書き込む．座標0,0を左上とする．
pyxel.image(0).set(
    0,
    0,
    [
        "44444444",  # 壁
        "42222444",
        "44422244",
        "44222444",
        "42224424",
        "22244444",
        "44442222",
        "22444442",
        "55555555",  # 道
        "55555555",
        "55555555",
        "55555555",
        "55555555",
        "55555555",
        "55555555",
        "55555555"
    ])

# 迷路のデータ
maze = [
    "****************",
    "* **************",
    "* **************",
    "* **************",
    "* **************",
    "*    ***********",
    "* **  **********",
    "***  ***********",
    "*** ******** ***",
    "*** ***      ***",
    "*** *** ********",
    "***     ********",
    "******* ********",
    "******* ********",
    "******* ********",
    "****************"
]

# タイルマップへ迷路のデータを書き込む
# "*"" -> 0, " " -> 32 (16進法で020)
# イメージバンク (0,0)-(7, 7), (0,8)-(7,15) に対応
for y in range(len(maze)):
    row = maze[y]
    for x in range(len(row)):
        if row[x] == "*":
            pyxel.tilemap(0).set(x, y, ["000"])  # (0,0)-(7,7)
        elif row[x] == " ":
            pyxel.tilemap(0).set(x, y, ["020"])  # (0,8)-(7,15)


class Player:
    def __init__(self):
        self.x = 8
        self.y = 8

    def update(self):
        newx = self.x
        newy = self.y
        if pyxel.btnp(pyxel.KEY_RIGHT):
            newx += 8
        elif pyxel.btnp(pyxel.KEY_LEFT):
            newx -= 8
        elif pyxel.btnp(pyxel.KEY_UP):
            newy -= 8
        elif pyxel.btnp(pyxel.KEY_DOWN):
            newy += 8
        tile = pyxel.tilemap(0).get(newx//8, newy//8)
        if tile == 32:  # 道がある
            self.x = newx
            self.y = newy

    def draw(self):
        pyxel.rectb(self.x, self.y, 8, 8, 15)


def update():
    player.update()


def draw():
    pyxel.cls(0)
    pyxel.bltm(0, 0, 0, 0, 0, 16, 16)
    player.draw()

player = Player()
pyxel.run(update, draw)
----
